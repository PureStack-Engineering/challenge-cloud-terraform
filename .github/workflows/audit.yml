name: PureStack Terraform Audit
on: [push, pull_request]

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: ğŸ—ï¸ Terraform Init
        run: terraform init -backend=false

      - name: ğŸ›¡ï¸ Syntax Validation
        run: terraform validate

      - name: ğŸ•µï¸ Resource Audit (Manual Check)
        run: |
          echo "Checking for mandatory resources..."
          
          if ! grep -q "resource \"aws_vpc\"" main.tf; then
            echo "âŒ Missing Resource: aws_vpc"
            exit 1
          fi
          
          if ! grep -q "resource \"aws_instance\"" main.tf; then
            echo "âŒ Missing Resource: aws_instance"
            exit 1
          fi

          if ! grep -q "resource \"aws_security_group\"" main.tf; then
             echo "âŒ Missing Resource: aws_security_group"
             exit 1
          fi

          echo "âœ… All mandatory resources detected."

      - name: ğŸ” Security Audit (Port 22 Check)
        # This is a simple check to see if they opened SSH to the world carelessly
        run: |
          if grep -q "from_port.*=.*22" main.tf && grep -q "0.0.0.0/0" main.tf; then
             echo "âš ï¸ WARNING: It looks like you opened SSH (22) to the world. Check your Security Group."
             # We don't fail the build to avoid false positives, but we log a warning.
          fi

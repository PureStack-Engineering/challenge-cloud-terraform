name: PureStack Infrastructure Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  iac-security-check:
    runs-on: ubuntu-latest
    name: â˜ï¸ IaC Security Gate

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Phase 1 Structural Integrity
        run: |
          echo "::group::Structure Validation"
          if [ ! -f "terraform/main.tf" ]; then echo "âŒ Missing: terraform/main.tf"; exit 1; fi
          if [ ! -f "tests/test_security.py" ]; then echo "âŒ Missing: tests/test_security.py"; exit 1; fi
          echo "âœ… Terraform structure is valid."
          echo "::endgroup::"

      - name: ğŸ•µï¸ Phase 2 Secret Scanning
        run: |
          echo "::group::Secret Detection"
          # Ban hardcoded AWS Access Keys
          if grep -r "access_key" terraform/; then echo "âŒ CRITICAL: Hardcoded 'access_key' detected."; exit 1; fi
          if grep -r "secret_key" terraform/; then echo "âŒ CRITICAL: Hardcoded 'secret_key' detected."; exit 1; fi
          echo "âœ… No hardcoded credentials found."
          echo "::endgroup::"

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: pip install -r requirements.txt

      - name: ğŸ§ª Phase 3 Policy as Code
        # Ejecuta pytest para validar que el bucket sea privado y SSH cerrado
        run: pytest tests/ -v
